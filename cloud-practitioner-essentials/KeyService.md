## AWS 핵심 서비스 
AWS를 기반하는 서비스를 설계할 때, 필수로 사용하는 서비스들을 살펴본다. 이들 서비스는 네트워크, 스토리지, 컴퓨팅, 데이터베이스, 빅데이터 등의 범주를 대표한다. 각각의 범주는 상당히 광범위한 내용을 다루므로 여기에서는 개략적인 설명만을 다루고, 각각에 대해서는 별도의 문서를 통해서 자세히 학습할 것이다.

## AWS 서비스 범주 소개 
AWS는 아래의 주요 서비스 범주를 가지고 있다.
  * 컴퓨팅
  * 스토리지
  * 데이터베이스
  * 네트워킹

### 컴퓨팅 
AWS는 EC2(Elastic Computing Cloud)라는 컴퓨팅 서비스를 제공한다. *메모리, CPU, 스토리지*로 구성된 물리적인 컴퓨터 시스템의 추상화다. 가상머신(Virtual Machine) 서비스라고 이해하면 된다.

컴퓨터 시스템이 다양한 CPU, Memory, Disk 용량을 가지듯이 EC2도 목적에 따른 다양한 "인스턴스 타입", "요금"등을 지원한다. 예를들어 개발자는 실행하려는 워크로드에 따라서 CPU 우선, 메모리 우선, GPU 우선등과 같은 적절한 인스턴스 타입과 CPU 갯수, 메모리 크기와 같은 용량을 선택해서 실행 할 수 있다. 또한 리눅스, 윈도우즈와 같은 운영체제를 선택할 수 있다.

EC2는 운영체제와 애플리케이션을 저장하기 위한 *블럭 스토리지*가 필요한데, EBS(Elastic Block Store)를 이용해서 스토리지를 EC2 인스턴스에 붙일 수(attach)할 수 있다. EBS는 하드디스크 서비스라고 볼 수 있다. AWS는 하드디스크 타입과 SSD 타입의 EBS 서비스를 제공하며, IOPS 설정 서비스도 제공한다.

### 데이터베이스
AWS는 Aurora, Amazon RDS, Amazon DynamoDB, Amazon Redshift등의 데이터베이스 서비스를 제공한다. 가용성, 확장성, 백업, 복구 등 일체의 관리를 AWS에 위임할 수 있다.

### 네트워크
AWS의 VPC는 네트워크 서비스다. 유저는 IP 기반의 네트워크를 할당받아서, 서브넷을 구성하고 라우터를 이용 인바운드&아웃바운드 트래픽을 제어 할 수 있다.

## AWS 글로벌 인프라
AWS는 전 지구를 커버하기 위한 글로벌 인프라를 제공한다. AWS의 글로벌 인프라는 *리전(Region), 가용영역(AZ), 엣지 로케이션(Edge location)*의 3개 요소로 구성된다.

### 리전
[AWS global infrastructure](https://aws.amazon.com/ko/about-aws/global-infrastructure/)에서 아래와 AWS의 글로벌 인프를 확인 할 수 있다.

![aws region 물리적 위치](https://d1.awsstatic.com/about-aws/regions/global-infra_3.30.18.b559f46825615c1ae40f319d0c4d9139fea9c492.png)

리전은 2개 이상의 가용영역(AZ)을 호스팅하는 지리영역을 가리킨다. 개발자가 인터넷 서비스를 전개하려고 하면 리전 중 하나를 선택할 수 있다. 당연히 서비스 지역과 가까운 위치의 리전을 선택할 것인데, "서비스 지연(latency)"에 직접적인 영향을 줄 것이기 때문이다.

예를 들어 대한민국을 목표로하는 서비스라면 서울리전에 배포를 할 것이다. 

각 리전간에는 사용 할 수 있는 AWS 서비스에 있어서 약간의 차이가 있다. [리전 테이블](https://aws.amazon.com/ko/about-aws/global-infrastructure/regional-product-services/)에서 리전간 제공 서비스 목록을 확인 할 수 있다.

따라서 개발자는 *가까운 리전*과 *리전에서 제공하는 기능 테이블* 두개를 비교해서 서비스를 선택해야 한다. 서비스에서 필요로 하는 모든 기능을 가까운 리전에서 제공한다면, 당연히 그 리전을 선택해야 되겠지만, 기능을 제공하지 않을 경우 고민이 필요 할 수 있다.

예를들어 DynamoDB Accelerator(DAX)의 경우 도쿄리전은 제공하지만 서울리전은 제공하지 않는다. DAX는 서비스 성능을 높이기 위한 기능이므로 서비스에 직접적인 영향을 끼치지는 않는다. 일반적인 상황에서 DAX 때문에 문제가 되는 경우는 없을테니, 서울리전에 구성하는게 나을 테다.

반면 비디오 서비스를 한다면 *Amazon Elastic Transcoder*가 있는 것과 없는 것은 꽤 큰 차이가 될 수 있다. 도쿄리전은 지원하지만 서울리전은 지원하지 않는데, 이 경우 Elastic Transcoder 관련 작업만 도쿄리전에서 수행하는 등의 고민을 해야 할 것이다.

### 가용영역
가용영역은 특정 리전에 존재하는 데이터센터의 모음이다. 
![AWS 가용영역](https://docs.google.com/drawings/d/e/2PACX-1vT1anL2RmGqaZZuw-kX3s24FO4nwOKVMeCUJuaWI3JKccPs6cKCGbL_aI3SZqDekt1eQHFP5GtwTyH_/pub?w=820&h=812)
가용영역은 다른 가용영역과 물리적,논리적으로 분리된다. 각 가용영역은 별도의 무정전 전원 공급장치(UPS), 예비 발전기, 냉각 장비, 네트워크, 전력망을 갖추고 있다. 하나의 리전은 두 개 이상의 가용영역으로 구성이 되는데, 서비스를 AZ에 분산해서 배치하면 AZ의 장애로 부터 안전한 서비스를 만들 수 있다. 

예를 들어 AZ-A와 AZ-B에 웹서버를 분산해 놓으면, AZ-A에 네트워크, 시스템, 소프트웨어 적인 문제가 생기더라도 AZ-B에서 작동중인 웹서버로 서비스를 계속 할 수 있다. 애초에 *가용 영역*이라는 용어 자체가 *가용성을 높이기 위한*이라는 의미를 함축하고 있다.

### 엣지로케이션
AWS는 *CloudFront*라는 CDN 서비스를 제공한다. 엣지로케이션(Edge Location)은 CloudFront를 제공하는 서비스 인프라다. CloudFront는 컨텐츠의 사본을 캐시해서 유저에게 빠르게 컨텐츠를 서비스하기 위해서 사용한다. 엣지로케이션은 CloudFront와 Route 53(도메인 서비스)에 대한 요청을 처리해서 사용자가 좀더 빠르게 서비스를 사용 할 수 있도록 한다. 
![엣지로케이션](https://d1.awsstatic.com/global-infrastructure/maps/AWS-CS-2383-Cloudfront-Map-15-Aug-2018.a015283a565a49343684f56190f31d163c77d4d8.png)

## Amazon Virtual Private Cloud(VPC)
### 소개
AWS VPC(Virtual Private Cloud)는 aws의 네트워크 서비스다. 전개하는 애플리케이션은 네트워크위상에 존재를 한다. 이 네트워크는 전통적인 *TCP/IP* 네트워크다. 클라우드 환경에서도 TCP/IP 네트워크를 개발자가 제어를 해야 하느냐라는 물음이 있을 수 있다. 이에 대한 답은 아래와 같다.
  * 90% 이상의 애플리케이션들은 TCP/IP 네트워크를 기반으로 한다. 특히 인터넷 애플리케이션이라면 100%라고 보면 된다.
  * 인터넷 서비스는 프론트앤드와 백앤드를 막론하고 TCP/IP 네트워크를 기반으로 한다.
  * 애플리케이션 배치, 보안에 대한 노하우도 TCP/IP 기준이다.
즉, 인터넷 서비스가 *서버리스(Serverless) 기반*에서 개발하지 않는 한, 전통적인 TCP/IP 네트워크를 구성해야 한다. 

개발자는 VPC를 이용해서 IP 주소공간, 서브넷(subnet), 라우팅 테이블과 같은 네트워크 구성 요소를 제어할 수 있다. 이를 통해서 인터넷에서 노출되는 자원과 격리해야 하는 자원을 제어할 수 있다.

개발자는 각 서브넷의 격리, 트래픽 흐름의 제어, 멀티닉을 이용한 트래픽 격리, ACL 정의, 라우팅 규칙등을 설정할 수 있다. 또한 수신 트래픽과 송신 트래픽을 허용 혹은 거부 할 수 있다. 

AWS의 EC2(Elastic Cloud Compute), RDS(Relational Database Service), ElasticCache 등 많은 AWS 서비스들이 개발자가 만든 VPC위에 배포된다. 이렇게 배포된 자원은 온프레미스 네트워크와 동일한 구조로 보호할 수 있다. VPC를 이해하면, AWS의 다른 서비스들도 통합할 수 있게 된다.

### 기능들
#### 리전과 AZ을 이용한 고가용성(High availability) 구성
VPC는 리전단위로 만들 수 있다. 리전은 하나 이상의 가용영역으로 구성되기 때문에, 개발자는 VPC를 만들 때, 네트워크가 가용영역으로 분산되도록 만들 수 있다. 

![리전 AZ을 이용한 고가용성 시스템 구성](https://docs.google.com/drawings/d/e/2PACX-1vRSUSnupcv8sMF_m5ooa8izQkmgJ_RBIwMKw7G98MONet9VtONbFEssrT1TBxDAhiX2SM_pQ1FQWR5b/pub?w=633&h=426)

서브넷을 AZ에 분산하는 것만으로 고가용성 시스템을 구성 할 수 있다. 예를들어 웹 애플리케이션 서버를 고가용성 구성으로 하고 싶다면, 3개의 서브넷을 3개의 AZ으로 구성하고, 각 서브넷에 애플리케이션 서버를 실행하면 된다. 이들 애플리케이션 서비스들은 ELB(Elastic Load balancer)로 묶으면 된다. 특정 AZ에 문제가 생겨서 서버에 연결할 수 없을 경우, 다른 AZ의 서버가 요청을 처리하게 된다. ELB는 자동으로 문제가 생긴 AZ로 요청을 보내지 않도록 조절하는 기능을 가지고 있다. 

#### 서브넷(Subnet)
VPC는 하나 이상의 서브넷을 가질 수 있다. 서브넷은 하나의 큰 네트워크를 여러개의 작은 네트워크로 나누기 위해서 사용한다. 서브넷은 애플리케이션의 격리, 네트워크간 트래픽 컨트롤, 보안, 트래픽 분리 와 같은 다양한 목적으로 나눈다. 서브넷이 많아지면 네트워크 토폴로지가 복잡해질 수 있으므로 적절한 설계가 필요하다.

개발자는 서브넷과 서브넷, 서브넷과 인터넷 사이의 트래픽을 제어하기 위해서 라우팅 테이블을 구성할 수 있다. 기본적으로 VPC 내의 모든 서브넷은 서로 통신 할 수 있다.    

서브넷은 퍼블릭 서브넷(Public subnet)과 프라이빗 서브넷(Private subnet)으로 분류 할 수 있다. 퍼블릭 서브넷은 인터넷(퍼블릭 네트워크)에서 직접 접근 할 수 있는 네트워크다. 반면 프라이빗 서브넷은 인터넷에서 접근 할 수 없다. 보통 퍼블릭 서브넷은 웹 서버, 웹 애플리케이션 서버와 같이 유저가 직접 접근해야 하는 서버를 배치하고 프라이빗 서브넷에는 데이터베이스와 같은 인터넷으로 부터 보호해야 하는 서버를 배치한다. 

서브넷이 *인터넷 게이트웨이(Internet gateway)*와 연결돼 있다면 퍼블릭 서브넷, 그렇지 않다면 프라이빗 서브넷이 된다.

#### 인터넷 게이트웨이(IGW)
인터넷 게이트웨이는 VPC 네트워크와 인터넷을 연결하는 관문역할을 한다. 퍼블릭 서브넷은 인터넷 게이트와 연결(attach)이 된다. 여기에 EC2를 배치하고, EIP 혹은 Public IP를 설정하면 인터넷에서 접근 할 수 있다. 

#### NAT 게이트웨이
프라이빗 서브넷의 EC2는 인터넷과 통신할 수 없다. 하지만 외부 API 호출, 외부 데이터 수집 등의 목적으로 *인터넷에 접근*이 필요한 경우가 있다. 이때는 NAT 게이트웨이를 설치해야 한다.

원리는 간단하다.
  * 퍼블릭 서브넷에 NAT 전용 EC2를 전개하고 NAT 설정을 한다.
  * 프라이빗 서브넷에서 0.0.0.0/0(인터넷)으로 향하는 트래픽이 NAT로 향하게 한다.
  * 프라이빗 서브넷의 EC2는 NAT 게이트웨이를 이용해서 인터넷에 접근할 수 있다.

AWS에서 NAT 게이트웨이를 서비스 하지 않을 때는 개발자가 EC2 인스턴스를 실행하고 NAT 설정을 해야 했으나, 지금은 AWS의 NAT 게이트웨이 서비스를 사용 할 수 있다.

#### Network Access Control Lists(NACL) 
VPC네트워크에서 서브넷간 트래픽의 접근을 제어한다. 시큐리티 그룹(Security group)과 비슷한데, 시큐리티그룹은 호스트 단위에서 트래픽을 제어한다.

#### 메인 퀘스트
AWS에서 VPC를 만든다. 아래의 퀘스트를 모두 수행해야 한다. 메인 퀘스트와 서브 퀘스트로 구성된다. 메인 퀘스트는 필수, 서브 퀘스트는 옵션이다.
  * 10.0.0.0/16 네트워크를 가지는 VPC를 만든다. 약 65,000개의 호스트를 관리할 수 있는 크기다. 
  * VPC에 퍼블릭 서브넷과 프라이빗 서브넷 2개의 서브넷을 만든다.
  * 퍼블릭 서브넷과 프라이빗 서브넷에 EC2 인스턴스를 만든다.
  * EC2 인스턴스간 통신이 되는지 확인한다. 
  * 퍼블릭 서브넷에 잇는 EC2 인스턴스에 Public IP를 할당해서, 인터넷에서 연결되는지 확인한다.

#### 서브 퀘스트
  * 서브넷에 대해서 살펴보기 
  * 퍼블릭 서브넷에서 프라이빗 서브넷으로 8080 포트로만 접근 할 수 있도록 NACL을 설정한다.
  * 우리가 만든 VPC의 네트워크 구성도를 그린다.
  * 프라이빗 서브넷에 있는 EC2 인스턴스에 접근하고 싶다. 어떻게 해야 할까. 

### 시큐리티 그룹(Security Group) 
클라우드는 컴퓨팅 파워, 네트워크, 스토리지, 소프트웨어를 대여하는 서비스다. 여러 기업들이 클라우드로 부터 자원을 대여하기 때문에 AWS는 다양한 보안 장치와 서비스들을 제공한다. 개발자들이 사용할 수 있는 일차 보안 장치가 *시큐리티그룹*이다.  

시큐리티 그룹은 일종의 방화벽으로 호스트(EC2와 같은)에서 작동한다. 시큐리티 그룹은 iptables와 같은 방화벽이 그렇듯이, IP와 Port를 기반으로 입/출력 트래픽을 제어한다. 이를테면  
  * 웹서버에서 웹 서비스 : 출발지가 0.0.0.0/0(Any) 이고 목적지가 80과 443인 트래픽만 허용한다.  
  * 웹서버에서 ssh 접근 : 관리를 위해서 ssh에 접근 할 수 있어야 할 것이다. 하지만 출발지가 0.0.0.0/0이어서는 안될 거다. ssh로의 접근은 사무실과 같은 특정 IP로 제한을 해야 한다. x.x.x.x/32와 같이 접근 할 수 있는 IP를 특정해버리거나 VPN 연결을 한 다음 VPN 네트워크에서의 접근만을 허용하도록 시큐리티 그룹을 설정한다. 
  * MySql RDS로의 접근 : Mysql은 웹 애플리케이션 서버에서 접근한다. 따라서 웹 애플리케이션 서버가 배치된 서브넷(예. 10.0.1.0/24)에서 3306 포트로 향하는 접근만 허용해야 한다. 데이터베이스 어드민도 접근을 해야 할 건데, VPN 네트워크에서만 접근 할 수 있도록 시큐리티 그룹을 설정한다.

아래의 예를 보자.

![시큐리티 그룹 예](https://docs.google.com/drawings/d/e/2PACX-1vR3lHMSZjkjbnQeU9Rl9E3BY851sOhUBAS73Ve_p-xT47qojs_axsYTow5eY8fkl18ncKBcmXWXx-zN/pub?w=870&h=565)

Web Tier는 인터넷 유저가 접근해야 하므로 0.0.0.0/0주소에서 80/443 포트로 향하는 트래픽을 허용했다. Application Tier는 Web Tier에서 접근해야 하므로 웹티어서브넷/24 주소에서 8080 포트로 향하는 트래픽을 허용했다. Databaser Tier는 Application Tier 서브넷에서 3306 포트로 향하는 트래픽을 허용한다. 그리고 관리의 목적으로 Company/24에서 22와 3306 포트로 향하는 트래픽을 허용한다. Comapny 네트워크와 VPC 네트워크는 VPN으로 연결된다. VPN은 여기에서는 자세히 다루지는 않겠다. 다른 모든 포트는 블럭(Block)했다.

시큐리티 그룹은 *화이트리스트*로 설정한다. 즉 허용하는 목록 외에는 모두 블럭처리 된다. 

### 컴퓨팅 서비스

### Elastic Compute Cloud

### AWS Lambda

### AWS Elastic Beanstalk

### Application Load Balancer

### Elastic Load Balancer

### Auto Scaling

### Amazon Elastic Block Store

### Amazon Simple Storage Service

### Amazon Glacier

### Amazon Relational Database Service

### Anazon DynamoDB

### Amazon Redshift

### Amazon Aurora

### AWS Trusted Advisor

## 참고
 * [CloudFront detail](https://aws.amazon.com/ko/cloudfront/details/)
